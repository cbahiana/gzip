#!/bin/sh -x
## you need to install uglify-es
# npm install -g uglify-es
## before you run uglify on WSL, you need to install it there
DIR=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
cd $DIR
#
#
#
uglifyjs --warn --comments all --ecma=5 --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./imagesloader.js -- ./imagesloader.es6
uglifyjs --warn --comments all --ecma=5 --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./imagesnojs.js -- ./imagesnojs.es6
#
#
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle --keep-fnames --output ./loader.min.js -- ./loader.js
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle --keep-fnames --output ./cssloader.min.js -- ./cssloader.js
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle --keep-fnames --output ./imagesloader.min.js -- ./imagesloader.js
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle --keep-fnames --output ./imagesnojs.min.js -- ./imagesnojs.js
#
#
#
cd ./js
# client side javascript
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/lib.js -- ./lib/lib.js ./lib/lib.ready.js\
  ./lib/lib.utils.js ./lib/lib.event.js ./lib/lib.options.js
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/lib.images.js --  ./lib/lib.images.js
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/intersection-observer.js --  ./lib/intersection-observer.js
# ./lib/lib.sw.js
#./localforage-all.js
uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/lib.js > ./dist/lib.min.js
uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/lib.images.js > ./dist/lib.images.min.js
uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/intersection-observer.js > ./dist/intersection-observer.min.js
# echo "/* do not edit! */" > ./localforage-all.js
#----- uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/localforage.js -- ./localforage/localforage.js ./localforage/localforage-getitems.js\
#-----  ./localforage/localforage-setitems.js ./localforage/localforage-removeitems.js
#----- uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/localforage.js > ./dist/localforage.min.js
# rm ./localforage-all.js
cd ..
#
#
#
node ./node_modules/webpack-cli/bin/cli.js --config webpack.config.js
#
#
cd ./worker/src
#
#
cat ../dist/serviceworker.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g" > ../dist/serviceworker.js
#
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/serviceworker.js > ../dist/serviceworker.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./administrator/sw.administrator.fetch.js ./administrator/sw.administrator.install.js ./administrator/sw.administrator.activate.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g" > ../dist/serviceworker.administrator.js
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/serviceworker.administrator.js > ../dist/serviceworker.administrator.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./browser.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g" > ../dist/browser.js
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./browser.sync.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g" > ../dist/browser.sync.js
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/browser.sync.js > ../dist/browser.sync.min.js
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/browser.js > ../dist/browser.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./browser.uninstall.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g" > ../dist/browser.uninstall.js
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/browser.uninstall.js > ../dist/browser.uninstall.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./browser.administrator.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g" > ../dist/browser.administrator.js
#
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/browser.administrator.js > ../dist/browser.administrator.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./onesignal/onesignal.js > ../dist/onesignal.js
#
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info","console.table","console.dir"]\
  --warn --mangle toplevel=true -- ../dist/onesignal.js > ../dist/onesignal.min.js
#
#
sha1sum ../dist/serviceworker.js | awk '{print $1;}' > ../../worker_version